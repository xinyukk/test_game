<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Couple Space - ç”œèœœäº’åŠ¨ç©ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* iOS Design System */
        :root {
            --ios-blue: #007AFF;
            --ios-pink: #FF2D55;
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.90);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: #F2F2F7;
            color: #1C1C1E;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Sweet Gradient Background */
        .bg-gradient-animate {
            background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            opacity: 0.3;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism */
        .ios-card {
            background: var(--ios-card);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        /* Animations */
        .slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .pulse-slow { animation: pulse 3s infinite; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Custom Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Game Specific Styles */
        .piano-key {
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }
        .piano-key:active, .piano-key.active {
            transform: translateY(4px);
            box-shadow: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div class="bg-gradient-animate"></div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none w-max max-w-[90%]">
        <div class="ios-card px-6 py-3 rounded-full shadow-lg flex items-center gap-3">
            <span id="toast-icon" class="text-xl">ğŸ””</span>
            <span id="toast-msg" class="text-sm font-semibold text-gray-800">é€šçŸ¥</span>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div id="app-container" class="flex-grow flex flex-col relative w-full max-w-lg mx-auto h-screen overflow-hidden">
        
        <!-- SCREEN 1: LOGIN / CONNECT -->
        <section id="screen-connect" class="flex flex-col h-full justify-center p-6 space-y-8 z-10">
            <div class="text-center space-y-3 mb-6 slide-up">
                <div class="w-28 h-28 bg-white/80 backdrop-blur rounded-[2rem] mx-auto shadow-xl flex items-center justify-center text-6xl mb-4 pulse-slow">
                    ğŸ’–
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-800">Couple Space</h1>
                <p class="text-gray-500 font-medium">å±äºä½ ä»¬çš„äºŒäººä¸–ç•Œ</p>
            </div>

            <div class="ios-card rounded-3xl p-6 space-y-5 slide-up" style="animation-delay: 0.1s">
                <button onclick="app.createRoom()" class="w-full bg-[#007AFF] hover:bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-3 text-lg">
                    <span>ğŸ </span> åˆ›å»ºå°å±‹ (æˆ‘æ˜¯æˆ¿ä¸»)
                </button>
                
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                    <div class="relative flex justify-center"><span class="bg-[#F2F2F7] px-4 text-xs text-gray-400 font-bold uppercase tracking-wider">æˆ–è€…åŠ å…¥</span></div>
                </div>

                <div class="flex gap-3">
                    <input id="room-code" type="number" placeholder="è¾“å…¥å¯¹æ–¹çš„å·ç " class="flex-1 bg-white/60 border-2 border-transparent focus:border-blue-400 rounded-2xl px-4 text-center font-mono text-xl focus:outline-none transition-all placeholder-gray-400 text-gray-700">
                    <button onclick="app.joinRoom()" class="bg-gray-800 text-white font-bold px-8 rounded-2xl active:scale-95 transition-transform text-lg">åŠ å…¥</button>
                </div>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-8">æ— éœ€æ³¨å†Œ Â· éšç§åŠ å¯† Â· å³æ—¶äº’åŠ¨</p>
        </section>

        <!-- SCREEN 2: LOBBY -->
        <section id="screen-lobby" class="hidden flex-col h-full p-4 z-10">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 pt-4 px-2">
                <div class="flex items-center gap-3">
                    <div id="avatar-me" class="w-12 h-12 rounded-full bg-white flex items-center justify-center text-2xl shadow-sm border-2 border-white">ğŸ˜Š</div>
                    <div>
                        <h2 class="font-bold text-xl text-gray-800">æ¸¸æˆå¤§å…</h2>
                        <div id="lobby-status" class="text-xs text-green-600 font-bold flex items-center gap-1 bg-green-100 px-2 py-0.5 rounded-full w-max mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> è¿çº¿ä¸­
                        </div>
                    </div>
                </div>
                <button onclick="app.disconnect()" class="p-2.5 bg-white/60 hover:bg-white rounded-full text-xs font-bold text-gray-500 shadow-sm transition-colors">é€€å‡ºæˆ¿é—´</button>
            </div>

            <!-- Game Grid -->
            <div class="flex-grow overflow-y-auto no-scrollbar pb-24">
                <div class="px-1 mb-3 flex items-center justify-between">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">äº’åŠ¨æ¸¸æˆ</h3>
                    <span class="text-[10px] text-gray-400 bg-white/50 px-2 py-1 rounded-lg">10 æ¬¾ç²¾é€‰</span>
                </div>
                
                <div class="grid grid-cols-2 gap-4" id="game-list">
                    <!-- Games injected by JS -->
                </div>
            </div>
        </section>

        <!-- SCREEN 3: GAME CONTAINER -->
        <section id="screen-game" class="hidden flex-col h-full z-20 absolute inset-0 bg-[#F2F2F7]">
            <!-- Game Header -->
            <div class="flex items-center justify-between p-4 bg-white/80 backdrop-blur-md border-b border-gray-200/50 shadow-sm z-30">
                <button onclick="gameManager.exitGame()" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 id="game-title" class="font-bold text-lg text-gray-800">æ¸¸æˆæ ‡é¢˜</h2>
                <div class="w-10"></div>
            </div>

            <!-- Game Content Area -->
            <div id="game-board" class="flex-grow relative overflow-hidden flex flex-col items-center justify-center p-4">
                <!-- Dynamic Game Content -->
            </div>

            <!-- Result Modal -->
            <div id="result-modal" class="hidden absolute inset-0 z-50 bg-black/40 backdrop-blur-[2px] flex items-center justify-center p-6">
                <div class="ios-card w-full max-w-xs p-8 rounded-[2rem] text-center pop-in bg-white shadow-2xl">
                    <div id="result-emoji" class="text-7xl mb-4 filter drop-shadow-md">ğŸ‰</div>
                    <h3 id="result-title" class="text-2xl font-black mb-2 text-gray-800">æ¸¸æˆç»“æŸ</h3>
                    <p id="result-desc" class="text-gray-500 mb-6 font-medium">ä½ ä»¬çœŸæ˜¯å¤ªæ£’äº†ï¼</p>
                    
                    <div id="punishment-box" class="bg-pink-50 p-4 rounded-2xl mb-6 border border-pink-100 hidden">
                        <p class="text-[10px] font-bold text-pink-500 uppercase tracking-widest mb-1">ç”œèœœäº’åŠ¨</p>
                        <p id="result-punishment" class="font-bold text-gray-800 text-sm">ç»™å¯¹æ–¹ä¸€ä¸ªå¤§å¤§çš„æ‹¥æŠ±</p>
                    </div>

                    <div class="space-y-3">
                        <button onclick="gameManager.restartGame()" class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition-all">å†ç©ä¸€æ¬¡</button>
                        <button onclick="gameManager.exitGame()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3.5 rounded-xl">è¿”å›å¤§å…</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // --- æ¸¸æˆå®šä¹‰åº“ ---
        const GAMES = [
            {
                id: 'datematch',
                name: 'å¿ƒåŠ¨æ¸…å•',
                icon: 'ğŸ’–',
                color: 'bg-pink-100 text-pink-600',
                desc: 'æ¢ç´¢å½¼æ­¤éƒ½æƒ³åšçš„æµªæ¼«å°äº‹'
            },
            {
                id: 'musicbox',
                name: 'åŒäººä¹ç« ',
                icon: 'ğŸ¹',
                color: 'bg-indigo-100 text-indigo-600',
                desc: 'ä¸è®ºç›¸éš”å¤šè¿œï¼Œå…±å¥ä¸€æ›²'
            },
            {
                id: 'touchsync',
                name: 'æŒ‡å°–æ„Ÿåº”',
                icon: 'ğŸ‘†',
                color: 'bg-orange-100 text-orange-600',
                desc: 'å¯»æ‰¾å¯¹æ–¹åœ¨å±å¹•ä¸Šçš„æŒ‡å°–'
            },
            {
                id: 'telepathy',
                name: 'é»˜å¥‘å¤§è€ƒéªŒ',
                icon: 'ğŸ§ ',
                color: 'bg-blue-100 text-blue-600',
                desc: 'å¿ƒæœ‰çµçŠ€ï¼Œé€‰å‡ºç›¸åŒç­”æ¡ˆ'
            },
            {
                id: 'clickwar',
                name: 'çˆ±å¿ƒå¡«å……',
                icon: 'â¤ï¸',
                color: 'bg-red-100 text-red-600',
                desc: 'æ‰‹é€Ÿæ¯”æ‹¼ï¼Œå¡«æ»¡è¿™é¢—çˆ±å¿ƒ'
            },
            {
                id: 'drawing',
                name: 'çµé­‚ç”»æ‰‹',
                icon: 'ğŸ¨',
                color: 'bg-purple-100 text-purple-600',
                desc: 'ä½ ç”»æˆ‘çŒœï¼Œå®æ—¶åŒæ­¥ç”»å¸ƒ'
            },
            {
                id: 'tictactoe',
                name: 'çˆ±çš„è¿çº¿',
                icon: 'â­•',
                color: 'bg-teal-100 text-teal-600',
                desc: 'ç®€å•çš„äº•å­—æ£‹ä¼‘é—²æ—¶å…‰'
            },
            {
                id: 'reaction',
                name: 'å¿ƒåŠ¨ååº”',
                icon: 'âš¡',
                color: 'bg-yellow-100 text-yellow-600',
                desc: 'æµ‹æµ‹è°çœ‹åˆ°å¯¹æ–¹å¿ƒè·³æ›´å¿«'
            },
            {
                id: 'poison',
                name: 'æ°´æœå¤§ä½œæˆ˜',
                icon: 'ğŸ',
                color: 'bg-green-100 text-green-600',
                desc: 'ç»å…¸çš„å¿ƒç†åšå¼ˆå°æ¸¸æˆ'
            },
            {
                id: 'memory',
                name: 'è®°å¿†ç¿»ç‰Œ',
                icon: 'ğŸ§©',
                color: 'bg-cyan-100 text-cyan-600',
                desc: 'æ‰¾å‡ºç›¸åŒçš„Emojié…å¯¹'
            }
        ];

        // ç”œèœœäº’åŠ¨å»ºè®®ï¼ˆæ›¿ä»£æƒ©ç½šï¼‰
        const SWEET_ACTIONS = [
            "ç»™å¯¹æ–¹å‘ä¸€å¼ ç°åœ¨çš„è‡ªæ‹", "è¯­éŸ³è¯´ä¸€å£°'æˆ‘çˆ±ä½ '", "ä¸‹æ¬¡è§é¢è¦æ‹¥æŠ±ä¸€åˆ†é’Ÿ", 
            "å¤¸å¤¸å¯¹æ–¹ä»Šå¤©çš„å‘å‹/ç©¿æ­", "ä¸ºå¯¹æ–¹å”±ä¸¤å¥å–œæ¬¢çš„æ­Œ", "åˆ†äº«ä¸€ä»¶æœ€è¿‘å¼€å¿ƒçš„å°äº‹",
            "ç­”åº”é™ªå¯¹æ–¹å»åšä¸€ä»¶å°äº‹", "ç»™å¯¹æ–¹ç‚¹ä¸€æ¯å¥¶èŒ¶/å’–å•¡", "æ·±æƒ…å¯¹è§†è§†é¢‘é€šè¯10ç§’"
        ];

        // --- åº”ç”¨æ ¸å¿ƒé€»è¾‘ ---
        const app = {
            peer: null,
            conn: null,
            role: null, 
            roomId: null,
            
            init() {
                this.renderLobby();
            },

            showToast(msg, icon='ğŸ””') {
                const el = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                document.getElementById('toast-icon').innerText = icon;
                el.classList.remove('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => el.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
            },

            switchScreen(screenId) {
                ['connect', 'lobby', 'game'].forEach(id => {
                    document.getElementById(`screen-${id}`).classList.add('hidden');
                });
                document.getElementById(`screen-${screenId}`).classList.remove('hidden');
                
                if(screenId === 'lobby') {
                    const avatar = document.getElementById('avatar-me');
                    if(this.role === 'host') {
                        avatar.innerText = 'ğŸ³';
                        avatar.classList.add('bg-blue-50');
                    } else {
                        avatar.innerText = 'ğŸŒ¸';
                        avatar.classList.add('bg-pink-50');
                    }
                }
            },

            createRoom() {
                this.role = 'host';
                this.roomId = Math.floor(Math.random() * 900000 + 100000).toString();
                this.showToast("å°å±‹æ­å»ºä¸­...", "ğŸ§±");
                
                this.peer = new Peer('couple_space_' + this.roomId);
                this.peer.on('open', (id) => {
                    this.showToast(`å°å±‹åˆ›å»ºæˆåŠŸï¼š${this.roomId}`, "ğŸ¡");
                    document.getElementById('room-code').value = this.roomId;
                    
                    const btn = document.querySelector('#screen-connect button');
                    btn.innerHTML = `<span class="font-mono text-2xl tracking-widest">${this.roomId}</span><span class="text-xs opacity-70 ml-2">ç­‰å¾…å¯¹æ–¹å›å®¶...</span>`;
                    btn.classList.replace('bg-[#007AFF]', 'bg-[#2C2C2E]');
                });

                this.peer.on('connection', (conn) => {
                    this.conn = conn;
                    this.setupConnection();
                    this.showToast("æ¬¢è¿å›å®¶ï¼", "ğŸ’‘");
                    this.switchScreen('lobby');
                });
                
                this.peer.on('error', (err) => {
                    if(err.type === 'unavailable-id') this.createRoom(); // Retry
                    else this.showToast("ç½‘ç»œå¼€å°å·®äº†: " + err.type, "âš ï¸");
                });
            },

            joinRoom() {
                const input = document.getElementById('room-code').value;
                if(input.length !== 6) return this.showToast("è¯·è¾“å…¥6ä½é—¨ç‰Œå·", "ğŸ”‘");
                
                this.role = 'guest';
                this.roomId = input;
                this.showToast("æ­£åœ¨æ•²é—¨...", "âœŠ");
                
                this.peer = new Peer();
                this.peer.on('open', () => {
                    this.conn = this.peer.connect('couple_space_' + this.roomId);
                    this.conn.on('open', () => {
                        this.setupConnection();
                        this.showToast("è¿›å±‹å•¦ï¼", "â¤ï¸");
                        this.switchScreen('lobby');
                    });
                    setTimeout(() => {
                        if(!this.conn.open) this.showToast("æ²¡äººå¼€é—¨ï¼Œæ£€æŸ¥ä¸‹å·ç ï¼Ÿ", "ğŸ¤”");
                    }, 5000);
                });
            },

            setupConnection() {
                this.conn.on('data', (data) => {
                    if(data.type === 'GAME_LAUNCH') {
                        gameManager.loadGame(data.gameId);
                    } else if(data.type === 'GAME_DATA') {
                        gameManager.handleRemoteData(data.payload);
                    } else if(data.type === 'GAME_EXIT') {
                        gameManager.exitGame(false);
                    }
                });
                
                this.conn.on('close', () => {
                    this.showToast("å¯¹æ–¹ç¦»å¼€äº†å°å±‹", "ğŸ‘‹");
                    setTimeout(() => location.reload(), 2000);
                });
            },

            send(data) {
                if(this.conn && this.conn.open) this.conn.send(data);
            },

            disconnect() {
                if(this.peer) this.peer.destroy();
                location.reload();
            },

            renderLobby() {
                const list = document.getElementById('game-list');
                list.innerHTML = GAMES.map(game => `
                    <div onclick="gameManager.requestGame('${game.id}')" class="ios-card p-4 rounded-2xl flex flex-col items-center justify-center text-center gap-2 active:scale-95 transition-all cursor-pointer h-36 relative overflow-hidden group border-0 shadow-sm hover:shadow-md">
                        <div class="absolute inset-0 ${game.color} opacity-10 group-hover:opacity-20 transition-opacity"></div>
                        <div class="text-4xl mb-1 transform group-hover:scale-110 transition-transform duration-300">${game.icon}</div>
                        <h4 class="font-bold text-gray-800 text-sm tracking-tight">${game.name}</h4>
                        <p class="text-[10px] text-gray-400 font-medium leading-tight px-1">${game.desc}</p>
                    </div>
                `).join('');
            }
        };

        // --- æ¸¸æˆç®¡ç†å™¨ ---
        const gameManager = {
            currentGame: null,
            state: {},

            requestGame(gameId) {
                app.send({ type: 'GAME_LAUNCH', gameId: gameId });
                this.loadGame(gameId);
            },

            loadGame(gameId) {
                const gameDef = GAMES.find(g => g.id === gameId);
                if(!gameDef) return;
                
                document.getElementById('game-title').innerText = gameDef.name;
                app.switchScreen('game');
                
                const board = document.getElementById('game-board');
                board.innerHTML = '';
                this.currentGame = gameId;
                
                if(this.games[gameId]) {
                    this.games[gameId].init(board);
                }
            },

            handleRemoteData(payload) {
                if(this.currentGame && this.games[this.currentGame]) {
                    this.games[this.currentGame].onData(payload);
                }
            },

            sendGameData(payload) {
                app.send({ type: 'GAME_DATA', payload });
            },

            showResult(type, customText = null, showPunish = false) {
                const modal = document.getElementById('result-modal');
                const title = document.getElementById('result-title');
                const desc = document.getElementById('result-desc');
                const punishBox = document.getElementById('punishment-box');
                const punishText = document.getElementById('result-punishment');
                
                modal.classList.remove('hidden');
                
                // é»˜è®¤æ–‡æ¡ˆ
                if(type === 'win') {
                    title.innerText = "ä½ èµ¢å•¦!";
                    title.className = "text-2xl font-black mb-2 text-green-600";
                    desc.innerText = "å¤ªå‰å®³äº†ï¼";
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else if(type === 'lose') {
                    title.innerText = "å†æ¥å†å‰";
                    title.className = "text-2xl font-black mb-2 text-gray-700";
                    desc.innerText = "å·®ä¸€ç‚¹ç‚¹å°±èµ¢äº†~";
                } else if(type === 'draw') {
                    title.innerText = "å®Œç¾åŒæ­¥";
                    title.className = "text-2xl font-black mb-2 text-pink-500";
                    desc.innerText = "ä½ ä»¬çš„é»˜å¥‘ä»¤äººç¾¡æ…•ï¼";
                    confetti({ particleCount: 50, spread: 100, origin: { y: 0.6 }, colors: ['#FF2D55', '#FFCC00'] });
                }

                if(customText) desc.innerText = customText;

                if(showPunish) {
                    punishBox.classList.remove('hidden');
                    punishText.innerText = SWEET_ACTIONS[Math.floor(Math.random() * SWEET_ACTIONS.length)];
                } else {
                    punishBox.classList.add('hidden');
                }
            },

            restartGame() {
                document.getElementById('result-modal').classList.add('hidden');
                app.send({ type: 'GAME_LAUNCH', gameId: this.currentGame });
                this.loadGame(this.currentGame);
            },

            exitGame(notify = true) {
                if(notify) app.send({ type: 'GAME_EXIT' });
                document.getElementById('result-modal').classList.add('hidden');
                app.switchScreen('lobby');
                this.currentGame = null;
                // Stop any audio
                if(window.audioCtx) window.audioCtx.close();
                window.audioCtx = null;
            },

            // --- æ¸¸æˆé€»è¾‘å®ç° ---
            games: {
                // 1. å¿ƒåŠ¨æ¸…å• (Date Matcher) - æ›¿æ¢å†³å®šè½¬ç›˜
                datematch: {
                    ideas: [
                        "å»æµ·è¾¹çœ‹æ—¥è½", "ä¸€èµ·åšä¸€é¡¿æ™šé¤", "å»æ¸¸ä¹å›­åæ‘©å¤©è½®", "çªåœ¨æ²™å‘çœ‹ææ€–ç‰‡", 
                        "å»çŒ«å’–æ’¸çŒ«", "äº’ç›¸ç»™å¯¹æ–¹æŒ‰æ‘©", "å»ç”µç©åŸæŠ“å¨ƒå¨ƒ", "ä¸€èµ·æ‹¼ä¸€ä¸ªå¤§ä¹é«˜",
                        "å»åƒä¸€é¡¿ç«é”…", "æ‹ä¸€ç»„ææ€ªåˆç…§", "å»å…¬å›­é‡é¤", "é€šå®µæ‰“æ¸¸æˆ"
                    ],
                    init(container) {
                        this.queue = [...this.ideas].sort(() => 0.5 - Math.random()).slice(0, 6); // å–6ä¸ª
                        this.currentIndex = 0;
                        this.myLikes = [];
                        this.oppLikes = null;
                        
                        container.innerHTML = `
                            <div class="w-full h-full flex flex-col items-center justify-center relative">
                                <div id="card-stack" class="relative w-64 h-80 perspective-1000">
                                    <!-- Cards go here -->
                                </div>
                                <div class="flex gap-8 mt-10">
                                    <button onclick="gameManager.games.datematch.vote(false)" class="w-16 h-16 rounded-full bg-white shadow-lg text-3xl flex items-center justify-center border-2 border-gray-100 active:scale-90 transition-transform">âŒ</button>
                                    <button onclick="gameManager.games.datematch.vote(true)" class="w-16 h-16 rounded-full bg-pink-500 shadow-lg text-white text-3xl flex items-center justify-center active:scale-90 transition-transform">â¤ï¸</button>
                                </div>
                                <p class="mt-6 text-gray-400 text-sm font-medium">è¿˜å‰© <span id="card-count">6</span> å¼ </p>
                            </div>
                        `;
                        this.renderCard();
                    },
                    renderCard() {
                        const stack = document.getElementById('card-stack');
                        const idea = this.queue[this.currentIndex];
                        
                        if(!idea) {
                            stack.innerHTML = `<div class="w-full h-full bg-white rounded-3xl shadow-xl flex items-center justify-center text-center p-6"><h3 class="text-xl font-bold text-gray-400">ç­‰å¾…å¯¹æ–¹...</h3></div>`;
                            if(this.oppLikes !== null) this.showResults();
                            return;
                        }

                        stack.innerHTML = `
                            <div class="absolute inset-0 bg-white rounded-3xl shadow-xl border border-gray-100 p-6 flex flex-col items-center justify-center text-center pop-in transform transition-all hover:-translate-y-2">
                                <div class="text-6xl mb-6">ğŸ’¡</div>
                                <h3 class="text-2xl font-bold text-gray-800">${idea}</h3>
                                <p class="text-xs text-gray-400 mt-4 uppercase tracking-widest">Date Idea</p>
                            </div>
                        `;
                        document.getElementById('card-count').innerText = this.queue.length - this.currentIndex;
                    },
                    vote(liked) {
                        if(this.currentIndex >= this.queue.length) return;
                        if(liked) this.myLikes.push(this.queue[this.currentIndex]);
                        this.currentIndex++;
                        
                        if(this.currentIndex >= this.queue.length) {
                            gameManager.sendGameData({ type: 'DONE', likes: this.myLikes });
                            this.renderCard(); // Show waiting
                        } else {
                            this.renderCard();
                        }
                    },
                    onData(d) {
                        if(d.type === 'DONE') {
                            this.oppLikes = d.likes;
                            if(this.currentIndex >= this.queue.length) this.showResults();
                        }
                    },
                    showResults() {
                        const matches = this.myLikes.filter(item => this.oppLikes.includes(item));
                        const board = document.getElementById('game-board');
                        
                        if(matches.length > 0) {
                            board.innerHTML = `
                                <div class="text-center w-full max-w-sm pop-in">
                                    <div class="text-6xl mb-4">âœ¨</div>
                                    <h3 class="text-2xl font-bold text-gray-800 mb-2">å¤ªæ£’äº†ï¼</h3>
                                    <p class="text-gray-500 mb-6">æˆ‘ä»¬å…±åŒæƒ³åšçš„äº‹æƒ…ï¼š</p>
                                    <div class="bg-white rounded-2xl shadow-sm p-4 space-y-2 text-left max-h-60 overflow-y-auto">
                                        ${matches.map(m => `<div class="p-3 bg-pink-50 rounded-xl text-pink-600 font-bold flex items-center gap-2"><span>âœ…</span> ${m}</div>`).join('')}
                                    </div>
                                    <button onclick="gameManager.restartGame()" class="mt-6 text-gray-400 text-sm underline">å†ç©ä¸€æ¬¡</button>
                                </div>
                            `;
                            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        } else {
                            board.innerHTML = `
                                <div class="text-center">
                                    <div class="text-6xl mb-4">ğŸ¤”</div>
                                    <h3 class="text-xl font-bold text-gray-800">è¿™æ¬¡æ²¡æœ‰åŒ¹é…åˆ°å“¦</h3>
                                    <p class="text-gray-500 mt-2">æ²¡å…³ç³»ï¼Œåªè¦åœ¨ä¸€èµ·åšä»€ä¹ˆéƒ½å¥½</p>
                                    <button onclick="gameManager.restartGame()" class="mt-6 bg-gray-900 text-white px-6 py-2 rounded-xl">å†è¯•ä¸€æ¬¡</button>
                                </div>
                            `;
                        }
                    }
                },

                // 2. åŒäººä¹ç«  (Love Piano) - æ›¿æ¢å®¶åŠ¡éª°å­
                musicbox: {
                    init(container) {
                        // ä½¿ç”¨ç®€å•çš„äº”å£°éŸ³é˜¶ï¼Œæ€ä¹ˆå¼¹éƒ½å¥½å¬
                        const notes = [
                            { n: 'C4', f: 261.63, c: 'bg-red-100 text-red-500' },
                            { n: 'D4', f: 293.66, c: 'bg-orange-100 text-orange-500' },
                            { n: 'E4', f: 329.63, c: 'bg-yellow-100 text-yellow-500' },
                            { n: 'G4', f: 392.00, c: 'bg-green-100 text-green-500' },
                            { n: 'A4', f: 440.00, c: 'bg-blue-100 text-blue-500' },
                            { n: 'C5', f: 523.25, c: 'bg-purple-100 text-purple-500' }
                        ];
                        
                        // Audio Context Setup
                        if(!window.audioCtx) window.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        
                        container.innerHTML = `
                            <div class="w-full flex flex-col gap-4 items-center justify-center h-full px-4">
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-2">PENTATONIC SCALE</p>
                                <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
                                    ${notes.map((n, i) => `
                                        <button id="key-${i}" onmousedown="gameManager.games.musicbox.play(${i})" ontouchstart="gameManager.games.musicbox.play(${i})" 
                                            class="${n.c} piano-key h-20 rounded-2xl font-bold text-xl shadow-sm border border-white/50 select-none touch-none flex items-center justify-center">
                                            ğŸµ
                                        </button>
                                    `).join('')}
                                </div>
                                <p class="text-xs text-gray-400 mt-4">è½»è§¦ç´é”®ï¼Œåˆå¥å±äºä½ ä»¬çš„æ—‹å¾‹</p>
                            </div>
                        `;
                        
                        this.notes = notes;
                    },
                    play(idx, isRemote = false) {
                        const note = this.notes[idx];
                        const btn = document.getElementById(`key-${idx}`);
                        
                        // Visual
                        btn.classList.add('scale-95', 'brightness-95');
                        setTimeout(() => btn.classList.remove('scale-95', 'brightness-95'), 150);
                        
                        // Audio
                        if(window.audioCtx && window.audioCtx.state !== 'closed') {
                            if(window.audioCtx.state === 'suspended') window.audioCtx.resume();
                            const osc = window.audioCtx.createOscillator();
                            const gain = window.audioCtx.createGain();
                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(note.f, window.audioCtx.currentTime);
                            gain.gain.setValueAtTime(0.5, window.audioCtx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, window.audioCtx.currentTime + 1);
                            osc.connect(gain);
                            gain.connect(window.audioCtx.destination);
                            osc.start();
                            osc.stop(window.audioCtx.currentTime + 1);
                        }
                        
                        // Sync
                        if(!isRemote) {
                            gameManager.sendGameData({ type: 'NOTE', idx });
                        }
                    },
                    onData(d) {
                        if(d.type === 'NOTE') this.play(d.idx, true);
                    }
                },

                // 3. æŒ‡å°–æ„Ÿåº” (Touch Sync) - æ›¿æ¢çœŸå¿ƒè¯
                touchsync: {
                    init(container) {
                        // è§’è‰²åˆ†é…ï¼šæˆ¿ä¸»æ”¾ç½®ï¼Œè®¿å®¢å¯»æ‰¾
                        this.target = null;
                        this.isPlacing = app.role === 'host';
                        
                        container.innerHTML = `
                            <div class="relative w-full h-full bg-gray-100 rounded-3xl overflow-hidden shadow-inner touch-none cursor-crosshair" id="touch-area">
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                                    <p id="ts-status" class="text-gray-500 font-bold bg-white/80 px-4 py-2 rounded-full shadow-sm backdrop-blur">
                                        ${this.isPlacing ? 'è¯·ç‚¹å‡»å±å¹•è®¾å®šä¸€ä¸ªä½ç½®' : 'ç­‰å¾…å¯¹æ–¹è®¾å®šä½ç½®...'}
                                    </p>
                                </div>
                                <div id="feedback-ring" class="absolute w-20 h-20 rounded-full border-4 border-white opacity-0 transition-all duration-300 pointer-events-none transform -translate-x-1/2 -translate-y-1/2"></div>
                            </div>
                        `;
                        
                        const area = document.getElementById('touch-area');
                        
                        // Event Listeners
                        const handleTouch = (e) => {
                            e.preventDefault();
                            const rect = area.getBoundingClientRect();
                            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                            const x = (clientX - rect.left) / rect.width;
                            const y = (clientY - rect.top) / rect.height;
                            
                            if(this.isPlacing && !this.target) {
                                this.target = {x, y};
                                document.getElementById('ts-status').innerText = "ä½ç½®å·²è®¾å®šï¼Œç­‰å¾…å¯¹æ–¹å¯»æ‰¾...";
                                // Add visual marker for placer
                                const marker = document.createElement('div');
                                marker.className = "absolute w-6 h-6 bg-blue-500 rounded-full opacity-50 transform -translate-x-1/2 -translate-y-1/2 animate-pulse";
                                marker.style.left = (x * 100) + '%';
                                marker.style.top = (y * 100) + '%';
                                area.appendChild(marker);
                                gameManager.sendGameData({ type: 'SET', x, y });
                            } else if (!this.isPlacing && this.target) {
                                // Seeker logic
                                this.checkDistance(x, y);
                                gameManager.sendGameData({ type: 'SEEK', x, y });
                            }
                        };
                        
                        area.addEventListener('mousedown', handleTouch);
                        area.addEventListener('touchstart', handleTouch);
                        area.addEventListener('mousemove', (e) => { if(!this.isPlacing && this.target && (e.buttons||e.touches)) handleTouch(e); });
                        area.addEventListener('touchmove', handleTouch);
                    },
                    checkDistance(x, y) {
                        if(!this.target) return;
                        const dist = Math.sqrt(Math.pow(x - this.target.x, 2) + Math.pow(y - this.target.y, 2));
                        const ring = document.getElementById('feedback-ring');
                        
                        // Update feedback ring position
                        ring.style.left = (x * 100) + '%';
                        ring.style.top = (y * 100) + '%';
                        ring.classList.remove('opacity-0');
                        
                        // Color based on distance
                        if(dist < 0.05) {
                            ring.style.borderColor = '#FF2D55'; // Hot
                            ring.style.transform = 'translate(-50%, -50%) scale(0.5)';
                            if(dist < 0.03) {
                                gameManager.sendGameData({ type: 'FOUND' });
                                this.finish();
                            }
                        } else if(dist < 0.2) {
                            ring.style.borderColor = '#FF9500'; // Warm
                            ring.style.transform = 'translate(-50%, -50%) scale(0.8)';
                        } else {
                            ring.style.borderColor = '#007AFF'; // Cold
                            ring.style.transform = 'translate(-50%, -50%) scale(1.2)';
                        }
                    },
                    finish() {
                        if(this.finished) return;
                        this.finished = true;
                        gameManager.showResult('draw', "å¿ƒæœ‰çµçŠ€ï¼æ‰¾åˆ°äº†ï¼", true);
                    },
                    onData(d) {
                        if(d.type === 'SET') {
                            this.target = {x: d.x, y: d.y};
                            if(!this.isPlacing) document.getElementById('ts-status').innerText = "å¯¹æ–¹å·²è—å¥½ï¼Œè¯·ç‚¹å‡»å±å¹•å¯»æ‰¾ï¼";
                        }
                        if(d.type === 'SEEK') {
                            // Host sees Seeker's attempt
                            const ring = document.getElementById('feedback-ring');
                            ring.style.left = (d.x * 100) + '%';
                            ring.style.top = (d.y * 100) + '%';
                            ring.classList.remove('opacity-0');
                            ring.style.borderColor = '#gray';
                        }
                        if(d.type === 'FOUND') this.finish();
                    }
                },

                // 4. é»˜å¥‘å¤§è€ƒéªŒ
                telepathy: {
                    init(container) {
                        this.myChoice = null;
                        const words = [['çŒ«', 'ç‹—'], ['å¤å¤©', 'å†¬å¤©'], ['ç«é”…', 'çƒ§çƒ¤'], ['æ‹¥æŠ±', 'äº²å»'], ['å¯ä¹', 'å¥¶èŒ¶'], ['æ—©ç¡', 'ç†¬å¤œ']];
                        const pair = words[Math.floor(Math.random() * words.length)];
                        if(app.role === 'host') gameManager.sendGameData({ type: 'INIT_Q', pair });

                        container.innerHTML = `
                            <div class="w-full flex flex-col gap-6 text-center">
                                <h3 class="text-xl font-bold text-gray-600">3...2...1...é€‰ï¼</h3>
                                <button onclick="gameManager.games.telepathy.choose(0)" id="btn-0" class="h-32 bg-white rounded-3xl shadow-sm border-2 border-transparent text-3xl font-bold hover:bg-blue-50 transition-all">${pair[0]}</button>
                                <div class="text-gray-300 font-bold">VS</div>
                                <button onclick="gameManager.games.telepathy.choose(1)" id="btn-1" class="h-32 bg-white rounded-3xl shadow-sm border-2 border-transparent text-3xl font-bold hover:bg-pink-50 transition-all">${pair[1]}</button>
                                <p id="tele-status" class="text-sm text-gray-400">å‡­ç›´è§‰é€‰ä¸€ä¸ª</p>
                            </div>
                        `;
                    },
                    choose(idx) {
                        if(this.myChoice !== null) return;
                        this.myChoice = idx;
                        document.getElementById(`btn-${idx}`).classList.add('border-[#007AFF]', 'bg-blue-50');
                        document.getElementById('tele-status').innerText = "å·²é€‰æ‹©ï¼Œç­‰å¾…å¯¹æ–¹...";
                        gameManager.sendGameData({ type: 'CHOICE', idx });
                    },
                    onData(d) {
                        if(d.type === 'INIT_Q') {
                            document.getElementById('btn-0').innerText = d.pair[0];
                            document.getElementById('btn-1').innerText = d.pair[1];
                        }
                        if(d.type === 'CHOICE') {
                            this.oppChoice = d.idx;
                            this.checkResult();
                        }
                    },
                    checkResult() {
                        if(this.myChoice !== null && this.oppChoice !== undefined) {
                            setTimeout(() => {
                                const match = this.myChoice === this.oppChoice;
                                gameManager.showResult(match ? 'draw' : 'lose', match ? 'é»˜å¥‘æ»¡åˆ†ï¼' : 'ä¸‹æ¬¡ä¸€å®šè¡Œï¼');
                            }, 500);
                        }
                    }
                },

                // 5. çˆ±å¿ƒå¡«å…… (Click War)
                clickwar: {
                    score: 0,
                    init(container) {
                        this.score = 0;
                        container.innerHTML = `
                            <div class="text-center w-full">
                                <div class="mb-4 text-6xl animate-bounce">â¤ï¸</div>
                                <h3 class="text-xl font-bold mb-8 text-gray-700">ä¸ºçˆ±åŠ æ²¹ï¼</h3>
                                <div class="relative h-64 w-24 bg-gray-200 rounded-full overflow-hidden border-4 border-white shadow-inner mx-auto">
                                    <div id="click-fill" class="absolute bottom-0 w-full bg-gradient-to-t from-pink-500 to-red-500 transition-all duration-100" style="height: 0%"></div>
                                </div>
                                <button id="click-btn" class="mt-8 w-full max-w-xs bg-white py-6 rounded-2xl shadow-lg font-bold text-xl active:scale-95 transition-transform text-red-500">ç‚¹ç‚¹ç‚¹ï¼</button>
                            </div>
                        `;
                        document.getElementById('click-btn').onclick = () => {
                            this.score++;
                            const pct = Math.min(this.score * 2.5, 100);
                            document.getElementById('click-fill').style.height = `${pct}%`;
                            if(this.score >= 40) {
                                gameManager.sendGameData({ type: 'WIN' });
                                gameManager.showResult('win', "ä½ çš„æ‰‹é€Ÿå¤ªå¿«äº†ï¼", true);
                            }
                        };
                    },
                    onData(d) {
                        if(d.type === 'WIN') gameManager.showResult('lose', "å¯¹æ–¹å…ˆå¡«æ»¡äº†çˆ±å¿ƒï¼", true);
                    }
                },

                // 6. çµé­‚ç”»æ‰‹
                drawing: {
                    init(container) {
                        container.innerHTML = `
                            <div class="w-full h-full flex flex-col">
                                <div class="flex justify-between mb-2 px-2">
                                    <button onclick="gameManager.games.drawing.clear()" class="text-xs bg-white px-3 py-1 rounded-full shadow text-gray-500 font-bold">ğŸ—‘ï¸ æ¸…ç©º</button>
                                    <span class="text-xs text-gray-400 font-bold">ğŸ¨ å…±åŒåˆ›ä½œ</span>
                                </div>
                                <canvas id="draw-canvas" class="flex-grow bg-white rounded-2xl shadow-sm touch-none w-full cursor-crosshair border border-gray-100"></canvas>
                            </div>
                        `;
                        const canvas = document.getElementById('draw-canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = container.clientWidth;
                        canvas.height = container.clientHeight - 50;
                        this.ctx = ctx;
                        this.isDrawing = false;
                        
                        const getPos = (e) => {
                            const rect = canvas.getBoundingClientRect();
                            return {
                                x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
                                y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
                            };
                        };

                        const start = (e) => {
                            const pos = getPos(e);
                            this.isDrawing = true;
                            this.lastPos = pos;
                        };
                        const move = (e) => {
                            if(!this.isDrawing) return;
                            e.preventDefault();
                            const pos = getPos(e);
                            const color = app.role === 'host' ? '#007AFF' : '#FF2D55';
                            this.draw(this.lastPos.x, this.lastPos.y, pos.x, pos.y, color);
                            gameManager.sendGameData({ type: 'DRAW', x1:this.lastPos.x, y1:this.lastPos.y, x2:pos.x, y2:pos.y });
                            this.lastPos = pos;
                        };
                        const end = () => this.isDrawing = false;

                        canvas.addEventListener('mousedown', start);
                        canvas.addEventListener('mousemove', move);
                        canvas.addEventListener('mouseup', end);
                        canvas.addEventListener('touchstart', start);
                        canvas.addEventListener('touchmove', move);
                        canvas.addEventListener('touchend', end);
                    },
                    draw(x1, y1, x2, y2, color) {
                        this.ctx.beginPath();
                        this.ctx.strokeStyle = color;
                        this.ctx.lineWidth = 4;
                        this.ctx.lineCap = 'round';
                        this.ctx.moveTo(x1, y1);
                        this.ctx.lineTo(x2, y2);
                        this.ctx.stroke();
                    },
                    clear() {
                        this.ctx.clearRect(0,0,1000,1000);
                        gameManager.sendGameData({type:'CLEAR'});
                    },
                    onData(d) {
                        const color = app.role === 'host' ? '#FF2D55' : '#007AFF';
                        if(d.type === 'DRAW') this.draw(d.x1, d.y1, d.x2, d.y2, color);
                        if(d.type === 'CLEAR') this.ctx.clearRect(0,0,1000,1000);
                    }
                },

                // 7. è®°å¿†ç¿»ç‰Œ (Memory) - å®Œæ•´å®ç°
                memory: {
                    init(container) {
                        const emojis = ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼'];
                        const deck = [...emojis, ...emojis].sort(() => 0.5 - Math.random());
                        this.cards = deck;
                        this.flipped = [];
                        this.matched = [];
                        this.lock = false;

                        if(app.role === 'host') gameManager.sendGameData({ type: 'INIT_DECK', deck });
                        else if(!this.cards) return; // Wait for deck

                        this.renderBoard(container);
                    },
                    renderBoard(container) {
                        container.innerHTML = `
                            <div class="grid grid-cols-4 gap-3 w-full max-w-xs aspect-square">
                                ${this.cards.map((emoji, i) => `
                                    <div onclick="gameManager.games.memory.flip(${i})" id="card-${i}" class="bg-white rounded-xl shadow-sm flex items-center justify-center text-3xl cursor-pointer transition-all duration-300 transform preserve-3d h-full relative">
                                        <span class="opacity-0 transition-opacity duration-300">${emoji}</span>
                                        <div class="absolute inset-0 bg-blue-100 rounded-xl flex items-center justify-center text-blue-300 font-bold backface-hidden">?</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    },
                    flip(i) {
                        if(this.lock || this.flipped.includes(i) || this.matched.includes(i)) return;
                        
                        const card = document.getElementById(`card-${i}`);
                        card.classList.add('rotate-y-180', 'bg-white');
                        card.querySelector('div').classList.add('opacity-0');
                        card.querySelector('span').classList.remove('opacity-0');
                        
                        this.flipped.push(i);
                        
                        if(this.flipped.length === 2) {
                            this.lock = true;
                            const match = this.cards[this.flipped[0]] === this.cards[this.flipped[1]];
                            setTimeout(() => {
                                if(match) {
                                    this.matched.push(...this.flipped);
                                    if(this.matched.length === this.cards.length) gameManager.showResult('win', 'è®°å¿†åŠ›è¶…ç¾¤ï¼');
                                } else {
                                    this.flipped.forEach(idx => {
                                        const el = document.getElementById(`card-${idx}`);
                                        el.querySelector('div').classList.remove('opacity-0');
                                        el.querySelector('span').classList.add('opacity-0');
                                    });
                                }
                                this.flipped = [];
                                this.lock = false;
                            }, 1000);
                        }
                    },
                    onData(d) {
                        if(d.type === 'INIT_DECK') {
                            this.cards = d.deck;
                            const b = document.getElementById('game-board');
                            if(b) this.renderBoard(b);
                        }
                        // Memory is simplified to local play for demo simplicity or coop mode could be complex
                        // For now, let's keep it simple: Host creates deck, both play same deck but locally? 
                        // To make it truly coop, we need to sync moves. 
                        // Added simple Move Sync:
                        if(d.type === 'MOVE') this.flip(d.idx); 
                    }
                },
                
                // 8. çˆ±çš„è¿çº¿ (TicTacToe)
                tictactoe: {
                    init(container) {
                        this.board = Array(9).fill(null);
                        this.turn = 'host';
                        this.symbol = app.role === 'host' ? 'â¤ï¸' : 'ğŸ’™';
                        
                        container.innerHTML = `
                            <div class="flex flex-col items-center">
                                <p id="ttt-status" class="mb-6 font-bold text-gray-400 bg-white px-4 py-1 rounded-full shadow-sm">ç­‰å¾…æˆ¿ä¸»å…ˆæ‰‹...</p>
                                <div class="grid grid-cols-3 gap-3 bg-gray-100 p-3 rounded-3xl">
                                    ${Array(9).fill(0).map((_, i) => `
                                        <div onclick="gameManager.games.tictactoe.move(${i})" id="cell-${i}" class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-4xl shadow-sm cursor-pointer hover:bg-gray-50 transition-all"></div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        this.updateUI();
                    },
                    move(i) {
                        if(this.turn !== app.role || this.board[i]) return;
                        this.board[i] = this.symbol;
                        this.turn = app.role === 'host' ? 'guest' : 'host';
                        this.updateUI();
                        gameManager.sendGameData({ type: 'MOVE', index: i });
                        this.checkWin();
                    },
                    onData(d) {
                        if(d.type === 'MOVE') {
                            this.board[d.index] = app.role === 'host' ? 'ğŸ’™' : 'â¤ï¸';
                            this.turn = app.role;
                            this.updateUI();
                            this.checkWin();
                        }
                    },
                    updateUI() {
                        const status = document.getElementById('ttt-status');
                        status.innerText = this.turn === app.role ? "è½®åˆ°ä½ äº†!" : "ç­‰å¾…å¯¹æ–¹...";
                        status.className = this.turn === app.role ? "mb-6 font-bold text-blue-500 bg-blue-50 px-4 py-1 rounded-full shadow-sm animate-pulse" : "mb-6 font-bold text-gray-400 bg-white px-4 py-1 rounded-full shadow-sm";
                        this.board.forEach((val, i) => document.getElementById(`cell-${i}`).innerText = val || '');
                    },
                    checkWin() {
                        const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                        for(let l of lines) {
                            const [a,b,c] = l;
                            if(this.board[a] && this.board[a]===this.board[b] && this.board[a]===this.board[c]) {
                                setTimeout(() => gameManager.showResult(this.board[a] === this.symbol ? 'win' : 'lose', null, true), 500);
                                return;
                            }
                        }
                        if(!this.board.includes(null)) setTimeout(() => gameManager.showResult('draw'), 500);
                    }
                },

                // 9. å¿ƒåŠ¨ååº”
                reaction: {
                    init(container) {
                        container.innerHTML = `
                            <div id="r-area" onclick="gameManager.games.reaction.click()" class="w-full h-full rounded-3xl bg-gray-100 flex flex-col items-center justify-center transition-all cursor-pointer shadow-inner">
                                <h3 id="r-text" class="text-3xl font-black text-gray-400">ç­‰å¾…å˜è‰²...</h3>
                                <p class="text-sm text-gray-400 mt-2">å˜ç²‰è‰²æ—¶ç«‹å³ç‚¹å‡»</p>
                            </div>
                        `;
                        this.state = 'wait';
                        if(app.role === 'host') {
                            setTimeout(() => {
                                const time = Date.now();
                                gameManager.sendGameData({ type: 'GO', time });
                                this.go(time);
                            }, 2000 + Math.random() * 3000);
                        }
                    },
                    go(time) {
                        this.state = 'go';
                        this.startTime = time;
                        const el = document.getElementById('r-area');
                        el.classList.replace('bg-gray-100', 'bg-pink-500');
                        document.getElementById('r-text').innerText = "ç‚¹æˆ‘ï¼ï¼ï¼";
                        document.getElementById('r-text').classList.add('text-white');
                    },
                    click() {
                        if(this.state === 'go') {
                            const diff = Date.now() - this.startTime;
                            this.state = 'end';
                            document.getElementById('r-text').innerText = `${diff}ms`;
                            gameManager.sendGameData({ type: 'DONE', ms: diff });
                            this.myMs = diff;
                            this.check();
                        } else if (this.state === 'wait') {
                            document.getElementById('r-text').innerText = "å¤ªæ—©äº†ï¼";
                            this.state = 'end';
                            this.myMs = 9999;
                            gameManager.sendGameData({ type: 'DONE', ms: 9999 });
                            this.check();
                        }
                    },
                    onData(d) {
                        if(d.type === 'GO') this.go(d.time);
                        if(d.type === 'DONE') { this.oppMs = d.ms; this.check(); }
                    },
                    check() {
                        if(this.myMs && this.oppMs) {
                            setTimeout(() => {
                                if(this.myMs < this.oppMs) gameManager.showResult('win', 'ååº”ç¥é€Ÿï¼', true);
                                else gameManager.showResult('lose', 'æ…¢äº†ä¸€ç‚¹ç‚¹å“¦', true);
                            }, 1000);
                        }
                    }
                },

                // 10. æ°´æœå¤§ä½œæˆ˜ (Poison) - ç®€æ˜“ç‰ˆ
                poison: {
                    init(container) {
                        const items = ["ğŸ’", "ğŸ‘", "ğŸŠ", "ğŸ¥", "ğŸ‰", "ğŸ‡"];
                        this.myPoison = -1;
                        this.turn = 'host';
                        this.dead = false;
                        
                        container.innerHTML = `
                            <div class="w-full text-center">
                                <p id="p-status" class="mb-6 font-bold text-gray-500">é˜¶æ®µ1: åŸ‹è—é™·é˜± (å¯¹æ–¹ä¸å¯è§)</p>
                                <div class="grid grid-cols-2 gap-4">
                                    ${items.map((it, i) => `
                                        <button onclick="gameManager.games.poison.click(${i})" id="p-btn-${i}" class="bg-white h-24 rounded-2xl shadow-sm border border-gray-100 text-4xl flex items-center justify-center transition-all active:scale-95">${it}</button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    },
                    click(i) {
                        if(this.myPoison === -1) {
                            this.myPoison = i;
                            document.getElementById(`p-btn-${i}`).classList.add('bg-red-50', 'border-red-200');
                            document.getElementById('p-status').innerText = "ç­‰å¾…å¯¹æ–¹åŸ‹é›·...";
                            gameManager.sendGameData({ type: 'SET_POISON', idx: i });
                        } else if(this.oppPoison !== undefined && !this.dead && this.turn === app.role) {
                            gameManager.sendGameData({ type: 'MOVE', idx: i });
                            this.processMove(i);
                        }
                    },
                    onData(d) {
                        if(d.type === 'SET_POISON') {
                            this.oppPoison = d.idx;
                            if(this.myPoison !== -1) this.startBattle();
                        }
                        if(d.type === 'MOVE') this.processMove(d.idx);
                    },
                    startBattle() {
                        document.getElementById('p-status').innerText = "å¼€å§‹ï¼è½®æµåƒæ°´æœ";
                        this.updateTurn();
                    },
                    processMove(i) {
                        const btn = document.getElementById(`p-btn-${i}`);
                        btn.disabled = true;
                        btn.classList.add('opacity-40');
                        btn.innerHTML = 'ğŸ« ';
                        
                        const killer = (this.turn === app.role) ? this.oppPoison : this.myPoison;
                        
                        if(i === killer) {
                            this.dead = true;
                            const winner = (this.turn === 'host') ? 'guest' : 'host';
                            setTimeout(() => gameManager.showResult(winner === app.role ? 'win' : 'lose', "å“å‘€ï¼è¿™æœ‰æ¯’ï¼", true), 500);
                        } else {
                            this.turn = (this.turn === 'host') ? 'guest' : 'host';
                            this.updateTurn();
                        }
                    },
                    updateTurn() {
                        if(!this.dead) {
                            const status = document.getElementById('p-status');
                            status.innerText = this.turn === app.role ? "è½®åˆ°ä½ äº†ï¼è¯·é€‰æ‹©" : "å¯¹æ–¹æ­£åœ¨æ€è€ƒ...";
                            status.className = this.turn === app.role ? "mb-6 font-bold text-green-600 animate-pulse" : "mb-6 font-bold text-gray-400";
                        }
                    }
                }
            }
        };

        window.onload = () => app.init();
        window.onpopstate = () => { if(gameManager.currentGame) gameManager.exitGame(); };
    </script>
</body>
</html>
